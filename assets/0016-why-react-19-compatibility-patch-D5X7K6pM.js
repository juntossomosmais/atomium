import{u as s,j as e,M as r}from"./iframe-BElrKgc3.js";import"./preload-helper-PPVm8Dsz.js";function i(t){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...s(),...t.components};return e.jsxs(e.Fragment,{children:[e.jsx(r,{title:"Docs/Architecture Decision Records/ADR 0016: Why React 19 compatibility patch?"}),`
`,e.jsx(n.h1,{id:"adr-0016-why-react-19-compatibility-patch",children:"ADR 0016: Why React 19 compatibility patch?"}),`
`,e.jsxs(n.p,{children:["üóìÔ∏è 2025-11 ¬∑ ‚úçÔ∏è ",e.jsx(n.a,{href:"https://twitter.com/felipefialho_",rel:"nofollow",children:"@felipefialho"})]}),`
`,e.jsx(n.h2,{id:"context",children:"Context"}),`
`,e.jsxs(n.p,{children:["Atomium uses Stencil to build Web Components and generates React wrappers using ",e.jsx(n.code,{children:"@stencil/react-output-target"}),". The project wraps many ",e.jsx(n.code,{children:"@ionic/core"})," components within custom Stencil components, and we need to upgrade to React 19 to keep dependencies up-to-date."]}),`
`,e.jsx(n.h2,{id:"problems",children:"Problems"}),`
`,e.jsx(n.h3,{id:"problem-1-locked-to-react-output-target-053",children:"Problem 1: Locked to react-output-target 0.5.3"}),`
`,e.jsxs(n.p,{children:["We are locked to ",e.jsx(n.code,{children:"@stencil/react-output-target"})," version ",e.jsx(n.strong,{children:"0.5.3"})," and cannot upgrade to newer versions (0.7.4+) due to a breaking change that affects Stencil components using ",e.jsx(n.code,{children:"@ionic/core"}),":"]}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Version 0.5.3"}),": Works correctly with Ionic-dependent components"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Version 0.7.4+"}),": Components wrapping Ionic components fail to render; non-Ionic components work normally"]}),`
`]}),`
`,e.jsxs(n.p,{children:["The breaking change involves the removal of the ",e.jsx(n.code,{children:"includeDefineCustomElements"})," option, which was crucial for automatic custom element registration in React projects."]}),`
`,e.jsxs(n.p,{children:["Reference: ",e.jsx(n.a,{href:"https://github.com/stenciljs/output-targets/issues/552",rel:"nofollow",children:"GitHub Issue #552 - React Output Target fails with Ionic components"})]}),`
`,e.jsx(n.p,{children:e.jsx(n.strong,{children:"Technical details:"})}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsx(n.li,{children:"Stencil version: 4.38.2"}),`
`,e.jsxs(n.li,{children:["TypeScript config: ",e.jsx(n.code,{children:'"module": "esnext"'})," and ",e.jsx(n.code,{children:'"moduleResolution": "bundler"'})]}),`
`,e.jsx(n.li,{children:"ESM-only module generation"}),`
`,e.jsx(n.li,{children:"Web Components wrapping Ionic Framework components"}),`
`]}),`
`,e.jsx(n.h3,{id:"problem-2-react-19-type-incompatibility",children:"Problem 2: React 19 type incompatibility"}),`
`,e.jsxs(n.p,{children:["React 19 introduced stricter TypeScript types for ",e.jsx(n.code,{children:"ForwardRef"})," and component props. The code generated by ",e.jsx(n.code,{children:"@stencil/react-output-target"})," 0.5.3 produces type errors when compiled against React 19:"]}),`
`,e.jsx(n.pre,{children:e.jsx(n.code,{className:"language-typescript",children:`// Generated by @stencil/react-output-target 0.5.3
return React.forwardRef<OverlayType, Props>((props, ref) => {
  return <Overlay {...props} forwardedRef={ref} />;
});

// TypeScript Error with React 19:
// TS2322: Type 'PropsWithoutRef<Props> & { forwardedRef: ForwardedRef<OverlayType>; }'
// is not assignable to type 'IntrinsicAttributes & IntrinsicClassAttributes<Overlay> & Readonly<Props>'
`})}),`
`,e.jsx(n.h3,{id:"constraints",children:"Constraints"}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsxs(n.li,{children:[e.jsxs(n.strong,{children:["Cannot upgrade ",e.jsx(n.code,{children:"@stencil/react-output-target"})]}),": Breaking changes in 0.7.4+ prevent Ionic components from rendering"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Cannot stay on React 18"}),": Need to keep dependencies up-to-date for security and ecosystem alignment"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Cannot modify generated files manually"}),": Files are regenerated on every build by Stencil"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Must maintain type safety"}),": TypeScript compilation must pass without errors"]}),`
`]}),`
`,e.jsx(n.h2,{id:"decision",children:"Decision"}),`
`,e.jsxs(n.p,{children:["We decided to implement a ",e.jsx(n.strong,{children:"custom Stencil output target"})," that modifies the generated React wrapper files to be compatible with React 19, following the same pattern as the existing ",e.jsx(n.code,{children:"reactBooleanFixOutputTarget"}),"."]}),`
`,e.jsx(n.h3,{id:"implementation",children:"Implementation"}),`
`,e.jsxs(n.p,{children:[e.jsx(n.strong,{children:"1. Custom Output Target"}),": ",e.jsx(n.code,{children:"packages/core/output-target/react-19-fix.ts"})]}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsx(n.li,{children:"Runs during the Stencil build process"}),`
`,e.jsxs(n.li,{children:["Listens for the ",e.jsx(n.code,{children:"react-library"})," generation to complete"]}),`
`,e.jsx(n.li,{children:"Applies type assertions to work around React 19's stricter types"}),`
`,e.jsx(n.li,{children:"Is idempotent (safe to run multiple times)"}),`
`,e.jsx(n.li,{children:"Includes detection for already-patched files"}),`
`]}),`
`,e.jsxs(n.p,{children:[e.jsx(n.strong,{children:"2. Stencil Configuration"}),": Added to ",e.jsx(n.code,{children:"packages/core/stencil.config.ts"})]}),`
`,e.jsx(n.pre,{children:e.jsx(n.code,{className:"language-typescript",children:`import { react19FixOutputTarget } from './output-target/react-19-fix'

export const config: Config = {
  outputTargets: [
    // ... other output targets
    react19FixOutputTarget({
      createOverlayComponentFile:
        '../../react/src/components/react-component-lib/createOverlayComponent.tsx',
      utilsIndexFile:
        '../../react/src/components/react-component-lib/utils/index.tsx',
    }),
  ]
}
`})}),`
`,e.jsx(n.p,{children:e.jsx(n.strong,{children:"3. Files Patched:"})}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsxs(n.li,{children:[e.jsx(n.code,{children:"createOverlayComponent.tsx"}),": Adds type assertions for overlay component refs"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.code,{children:"utils/index.tsx"}),": Adds type assertions for ",e.jsx(n.code,{children:"createForwardRef"})," function"]}),`
`]}),`
`,e.jsx(n.h3,{id:"patch-details",children:"Patch Details"}),`
`,e.jsx(n.p,{children:e.jsxs(n.strong,{children:["File: ",e.jsx(n.code,{children:"createOverlayComponent.tsx"})]})}),`
`,e.jsx(n.pre,{children:e.jsx(n.code,{className:"language-typescript",children:`// Before (generated by Stencil)
return React.forwardRef<OverlayType, Props>((props, ref) => {
  return <Overlay {...props} forwardedRef={ref} />;
});

// After (patched for React 19)
return React.forwardRef<OverlayType, Props>((props, ref) => {
  const overlayProps = { ...props, forwardedRef: ref } as any;
  return <Overlay {...overlayProps} />;
}) as any;
`})}),`
`,e.jsx(n.p,{children:e.jsxs(n.strong,{children:["File: ",e.jsx(n.code,{children:"utils/index.tsx"})]})}),`
`,e.jsx(n.pre,{children:e.jsx(n.code,{className:"language-typescript",children:`// Before (generated by Stencil)
return React.forwardRef(forwardRef);

// After (patched for React 19)
return React.forwardRef(forwardRef as any) as any;
`})}),`
`,e.jsx(n.h3,{id:"testing",children:"Testing"}),`
`,e.jsxs(n.p,{children:["Comprehensive test suite in ",e.jsx(n.code,{children:"packages/core/output-target/react-19-fix.spec.ts"})," validates:"]}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsx(n.li,{children:"‚úÖ Correct patching of both files during Stencil build"}),`
`,e.jsx(n.li,{children:"‚úÖ Integration with Stencil's compilation lifecycle"}),`
`,e.jsx(n.li,{children:"‚úÖ Graceful handling of missing files"}),`
`]}),`
`,e.jsx(n.h3,{id:"positive-outcomes",children:"Positive outcomes"}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"React 19 Compatibility"}),": Project successfully builds and runs with React 19.2.0"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Maintains Ionic Integration"}),": Can continue using ",e.jsx(n.code,{children:"@stencil/react-output-target"})," 0.5.3"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Automated Solution"}),": No manual intervention required; patches apply automatically on every build"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Type Safety Maintained"}),": TypeScript compilation passes without errors"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Testable"}),": Patch logic is thoroughly tested"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Future-Proof"}),": When ",e.jsx(n.code,{children:"@stencil/react-output-target"})," resolves Ionic issues, we can upgrade and remove the patch"]}),`
`]}),`
`,e.jsx(n.h3,{id:"trade-offs",children:"Trade-offs"}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Type Assertions Used"}),": The ",e.jsx(n.code,{children:"as any"})," assertions bypass TypeScript's type checking for these specific cases",`
`,e.jsxs(n.ul,{children:[`
`,e.jsx(n.li,{children:"Risk is low - the underlying implementation is sound; only the type definitions are incompatible"}),`
`,e.jsx(n.li,{children:"Mitigated by comprehensive runtime testing through Storybook and component tests"}),`
`]}),`
`]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Build Dependency"}),": Adds an extra step in the build process (minimal impact - script executes in milliseconds)"]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Maintenance Burden"}),": Need to monitor for changes in generated code structure",`
`,e.jsxs(n.ul,{children:[`
`,e.jsx(n.li,{children:"Test suite will catch breaking changes"}),`
`,e.jsx(n.li,{children:"Patch script warns when patterns aren't found"}),`
`]}),`
`]}),`
`,e.jsxs(n.li,{children:[e.jsx(n.strong,{children:"Technical Debt"}),": This is a workaround, not a permanent solution",`
`,e.jsxs(n.ul,{children:[`
`,e.jsxs(n.li,{children:["We track ",e.jsx(n.a,{href:"https://github.com/stenciljs/output-targets/issues/552",rel:"nofollow",children:"GitHub Issue #552"})," for resolution"]}),`
`,e.jsx(n.li,{children:"When Ionic compatibility is fixed in newer versions, we can upgrade and remove the patch"}),`
`]}),`
`]}),`
`]}),`
`,e.jsx(n.h2,{id:"alternatives-considered",children:"Alternatives considered"}),`
`,e.jsxs(n.h3,{id:"alternative-1-fork-stencilreact-output-target",children:["Alternative 1: Fork ",e.jsx(n.code,{children:"@stencil/react-output-target"})]}),`
`,e.jsxs(n.p,{children:[e.jsx(n.strong,{children:"Rejected"})," - Too much maintenance overhead. Would require manually syncing updates and maintaining divergence from official package."]}),`
`,e.jsx(n.h3,{id:"alternative-2-downgrade-to-react-18",children:"Alternative 2: Downgrade to React 18"}),`
`,e.jsxs(n.p,{children:[e.jsx(n.strong,{children:"Rejected"})," - Not sustainable long-term. Would create security vulnerabilities and ecosystem misalignment."]}),`
`,e.jsx(n.h3,{id:"alternative-3-rewrite-components-without-ionic",children:"Alternative 3: Rewrite Components Without Ionic"}),`
`,e.jsxs(n.p,{children:[e.jsx(n.strong,{children:"Rejected"})," - Not feasible. Would require rewriting 100+ components, losing Ionic's battle-tested implementations, and risk introducing bugs."]}),`
`,e.jsx(n.h3,{id:"alternative-4-wait-for-upstream-fix",children:"Alternative 4: Wait for Upstream Fix"}),`
`,e.jsxs(n.p,{children:[e.jsx(n.strong,{children:"Rejected"})," - Cannot wait indefinitely. Issue has been open since May 2024 with no timeline for resolution. This blocks React 19 adoption and creates security risks."]}),`
`,e.jsx(n.h2,{id:"references",children:"References"}),`
`,e.jsxs(n.ul,{children:[`
`,e.jsx(n.li,{children:e.jsx(n.a,{href:"https://github.com/stenciljs/output-targets/issues/552",rel:"nofollow",children:"GitHub Issue #552: React Output Target fails with Ionic components"})}),`
`,e.jsx(n.li,{children:e.jsx(n.a,{href:"https://react.dev/blog/2024/12/05/react-19",rel:"nofollow",children:"React 19 Release Notes"})}),`
`,e.jsx(n.li,{children:e.jsx(n.a,{href:"https://stenciljs.com/docs/react",rel:"nofollow",children:"Stencil React Output Target Documentation"})}),`
`,e.jsx(n.li,{children:e.jsx(n.a,{href:"https://stenciljs.com/docs/output-targets#custom-output-targets",rel:"nofollow",children:"Stencil Custom Output Targets"})}),`
`,e.jsxs(n.li,{children:["Output Target Implementation: ",e.jsx(n.code,{children:"packages/core/output-target/react-19-fix.ts"})]}),`
`,e.jsxs(n.li,{children:["Test Suite: ",e.jsx(n.code,{children:"packages/core/output-target/react-19-fix.spec.ts"})]}),`
`,e.jsx(n.li,{children:"Related: ADR 0010 (React Boolean Fix) - Similar pattern"}),`
`]})]})}function l(t={}){const{wrapper:n}={...s(),...t.components};return n?e.jsx(n,{...t,children:e.jsx(i,{...t})}):i(t)}export{l as default};
