"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.readProjectGraph = exports.ensureGlobalProjectGraph = void 0;
const devkit_1 = require("@nrwl/devkit");
const runtime_lint_utils_1 = require("./runtime-lint-utils");
const chalk = require("chalk");
const find_project_for_path_1 = require("nx/src/project-graph/utils/find-project-for-path");
const file_utils_1 = require("nx/src/project-graph/file-utils");
function ensureGlobalProjectGraph(ruleName) {
    /**
     * Only reuse graph when running from terminal
     * Enforce every IDE change to get a fresh nxdeps.json
     */
    if (!global.projectGraph ||
        !global.projectRootMappings ||
        !(0, runtime_lint_utils_1.isTerminalRun)()) {
        const nxJson = (0, file_utils_1.readNxJson)();
        global.workspaceLayout = nxJson.workspaceLayout;
        /**
         * Because there are a number of ways in which the rule can be invoked (executor vs ESLint CLI vs IDE Plugin),
         * the ProjectGraph may or may not exist by the time the lint rule is invoked for the first time.
         */
        try {
            global.projectGraph = (0, devkit_1.readCachedProjectGraph)();
            global.projectRootMappings = (0, find_project_for_path_1.createProjectRootMappings)(global.projectGraph.nodes);
        }
        catch (_a) {
            const WARNING_PREFIX = `${chalk.reset.keyword('orange')('warning')}`;
            const RULE_NAME_SUFFIX = `${chalk.reset.dim(`@nrwl/nx/${ruleName}`)}`;
            process.stdout
                .write(`${WARNING_PREFIX} No cached ProjectGraph is available. The rule will be skipped.
          If you encounter this error as part of running standard \`nx\` commands then please open an issue on https://github.com/nrwl/nx
          ${RULE_NAME_SUFFIX}\n`);
        }
    }
}
exports.ensureGlobalProjectGraph = ensureGlobalProjectGraph;
function readProjectGraph(ruleName) {
    ensureGlobalProjectGraph(ruleName);
    return {
        projectGraph: global.projectGraph,
        projectRootMappings: global.projectRootMappings,
    };
}
exports.readProjectGraph = readProjectGraph;
//# sourceMappingURL=project-graph-utils.js.map