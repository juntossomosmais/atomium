"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cypressInitSchematic = exports.cypressInitGenerator = void 0;
const tslib_1 = require("tslib");
const devkit_1 = require("@nrwl/devkit");
const versions_1 = require("../../utils/versions");
const js_1 = require("@nrwl/js");
function setupE2ETargetDefaults(tree) {
    var _a, _b, _c, _d;
    var _e, _f;
    const nxJson = (0, devkit_1.readNxJson)(tree);
    if (!nxJson.namedInputs) {
        return;
    }
    // E2e targets depend on all their project's sources + production sources of dependencies
    (_a = nxJson.targetDefaults) !== null && _a !== void 0 ? _a : (nxJson.targetDefaults = {});
    const productionFileSet = !!((_b = nxJson.namedInputs) === null || _b === void 0 ? void 0 : _b.production);
    (_c = (_e = nxJson.targetDefaults).e2e) !== null && _c !== void 0 ? _c : (_e.e2e = {});
    (_d = (_f = nxJson.targetDefaults.e2e).inputs) !== null && _d !== void 0 ? _d : (_f.inputs = [
        'default',
        productionFileSet ? '^production' : '^default',
    ]);
    (0, devkit_1.updateNxJson)(tree, nxJson);
}
function updateDependencies(tree) {
    (0, devkit_1.removeDependenciesFromPackageJson)(tree, ['@nrwl/cypress'], []);
    return (0, devkit_1.addDependenciesToPackageJson)(tree, {}, {
        ['@nrwl/cypress']: versions_1.nxVersion,
        cypress: versions_1.cypressVersion,
        '@types/node': versions_1.typesNodeVersion,
    });
}
function cypressInitGenerator(tree, options) {
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        setupE2ETargetDefaults(tree);
        const tasks = [];
        tasks.push(yield (0, js_1.initGenerator)(tree, Object.assign(Object.assign({}, options), { skipFormat: true })));
        if (!options.skipPackageJson) {
            tasks.push(updateDependencies(tree));
        }
        return (0, devkit_1.runTasksInSerial)(...tasks);
    });
}
exports.cypressInitGenerator = cypressInitGenerator;
exports.default = cypressInitGenerator;
exports.cypressInitSchematic = (0, devkit_1.convertNxGenerator)(cypressInitGenerator);
//# sourceMappingURL=init.js.map