import{__require}from"./chunk-GYZG6JM4.mjs";import{dirname,join}from"path";var defaultStaticDirs=[{from:join(dirname(__require.resolve("@storybook/manager/package.json")),"static"),to:"/sb-common-assets"}];import{logger}from"@storybook/node-logger";import{getDirectoryFromWorkingDir}from"@storybook/core-common";import chalk from"chalk";import express from"express";import{pathExists}from"fs-extra";import path from"path";import favicon from"serve-favicon";import isEqual from"lodash/isEqual.js";import{dedent}from"ts-dedent";async function useStatics(router,options){let staticDirs=await options.presets.apply("staticDirs"),faviconPath=await options.presets.apply("favicon");if(options.staticDir&&!isEqual(staticDirs,defaultStaticDirs))throw new Error(dedent`
      Conflict when trying to read staticDirs:
      * Storybook's configuration option: 'staticDirs'
      * Storybook's CLI flag: '--staticDir' or '-s'
      
      Choose one of them, but not both.
    `);let statics=[...staticDirs.map(dir=>typeof dir=="string"?dir:`${dir.from}:${dir.to}`),...options.staticDir||[]];statics&&statics.length>0&&await Promise.all(statics.map(async dir=>{try{let relativeDir=staticDirs?getDirectoryFromWorkingDir({configDir:options.configDir,workingDir:process.cwd(),directory:dir}):dir,{staticDir,staticPath,targetEndpoint}=await parseStaticDir(relativeDir);targetEndpoint.startsWith("/sb-")||logger.info(chalk`=> Serving static files from {cyan ${staticDir}} at {cyan ${targetEndpoint}}`),router.use(targetEndpoint,express.static(staticPath,{index:!1}))}catch(e){logger.warn(e.message)}})),router.use(favicon(faviconPath))}var parseStaticDir=async arg=>{let lastColonIndex=arg.lastIndexOf(":"),isWindowsRawDirOnly=path.win32.isAbsolute(arg)&&lastColonIndex===1,splitIndex=lastColonIndex!==-1&&!isWindowsRawDirOnly?lastColonIndex:arg.length,target=(arg.substring(splitIndex+1)||"/").split(path.sep).join(path.posix.sep),rawDir=arg.substring(0,splitIndex),staticDir=path.isAbsolute(rawDir)?rawDir:`./${rawDir}`,staticPath=path.resolve(staticDir),targetDir=target.replace(/^\/?/,"./"),targetEndpoint=targetDir.substring(1);if(!await pathExists(staticPath))throw new Error(dedent(chalk`
        Failed to load static files, no such directory: {cyan ${staticPath}}
        Make sure this directory exists, or omit the {bold -s (--static-dir)} option.
      `));return{staticDir,staticPath,targetDir,targetEndpoint}};export{defaultStaticDirs,useStatics,parseStaticDir};
