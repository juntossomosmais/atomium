var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty;var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})},__copyProps=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames(from))!__hasOwnProp.call(to,key)&&key!==except&&__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,"default",{value:mod,enumerable:!0}):target,mod)),__toCommonJS=mod=>__copyProps(__defProp({},"__esModule",{value:!0}),mod);var src_exports={};__export(src_exports,{KEY:()=>KEY,PostmsgTransport:()=>PostmsgTransport,createChannel:()=>createChannel,default:()=>src_default});module.exports=__toCommonJS(src_exports);var import_global=require("@storybook/global"),EVENTS=__toESM(require("@storybook/core-events")),import_channels=require("@storybook/channels"),import_client_logger=require("@storybook/client-logger"),import_telejson=require("telejson"),import_qs=__toESM(require("qs")),{document,location}=import_global.global,KEY="storybook-channel",defaultEventOptions={allowFunction:!0,maxDepth:25},PostmsgTransport=class{constructor(config){this.config=config;var _a;if(this.buffer=[],this.handler=null,typeof((_a=import_global.global)==null?void 0:_a.addEventListener)=="function"&&import_global.global.addEventListener("message",this.handleEvent.bind(this),!1),config.page!=="manager"&&config.page!=="preview")throw new Error(`postmsg-channel: "config.page" cannot be "${config.page}"`)}setHandler(handler){this.handler=(...args)=>{handler.apply(this,args),!this.connected&&this.getLocalFrame().length&&(this.flush(),this.connected=!0)}}send(event,options){let{target,allowRegExp,allowFunction,allowSymbol,allowDate,allowUndefined,allowClass,maxDepth,space,lazyEval}=options||{},eventOptions=Object.fromEntries(Object.entries({allowRegExp,allowFunction,allowSymbol,allowDate,allowUndefined,allowClass,maxDepth,space,lazyEval}).filter(([k,v])=>typeof v<"u")),stringifyOptions={...defaultEventOptions,...import_global.global.CHANNEL_OPTIONS||{},...eventOptions},frames=this.getFrames(target),query=import_qs.default.parse(location.search,{ignoreQueryPrefix:!0}),data=(0,import_telejson.stringify)({key:KEY,event,refId:query.refId},stringifyOptions);return frames.length?(this.buffer.length&&this.flush(),frames.forEach(f=>{try{f.postMessage(data,"*")}catch{console.error("sending over postmessage fail")}}),Promise.resolve(null)):new Promise((resolve,reject)=>{this.buffer.push({event,resolve,reject})})}flush(){let{buffer}=this;this.buffer=[],buffer.forEach(item=>{this.send(item.event).then(item.resolve).catch(item.reject)})}getFrames(target){if(this.config.page==="manager"){let list=Array.from(document.querySelectorAll("iframe[data-is-storybook][data-is-loaded]")).filter(e=>{try{return!!e.contentWindow&&e.dataset.isStorybook!==void 0&&e.id===target}catch{return!1}}).map(e=>e.contentWindow);return list.length?list:this.getCurrentFrames()}return import_global.global&&import_global.global.parent&&import_global.global.parent!==import_global.global.self?[import_global.global.parent]:[]}getCurrentFrames(){return this.config.page==="manager"?Array.from(document.querySelectorAll('[data-is-storybook="true"]')).map(e=>e.contentWindow):import_global.global&&import_global.global.parent?[import_global.global.parent]:[]}getLocalFrame(){return this.config.page==="manager"?Array.from(document.querySelectorAll("#storybook-preview-iframe")).map(e=>e.contentWindow):import_global.global&&import_global.global.parent?[import_global.global.parent]:[]}handleEvent(rawEvent){try{let{data}=rawEvent,{key,event,refId}=typeof data=="string"&&(0,import_telejson.isJSON)(data)?(0,import_telejson.parse)(data,import_global.global.CHANNEL_OPTIONS||{}):data;if(key===KEY){let pageString=this.config.page==="manager"?'<span style="color: #37D5D3; background: black"> manager </span>':'<span style="color: #1EA7FD; background: black"> preview </span>',eventString=Object.values(EVENTS).includes(event.type)?`<span style="color: #FF4785">${event.type}</span>`:`<span style="color: #FFAE00">${event.type}</span>`;if(refId&&(event.refId=refId),event.source=this.config.page==="preview"?rawEvent.origin:getEventSourceUrl(rawEvent),!event.source){import_client_logger.pretty.error(`${pageString} received ${eventString} but was unable to determine the source of the event`);return}let message=`${pageString} received ${eventString} (${data.length})`;import_client_logger.pretty.debug(location.origin!==event.source?message:`${message} <span style="color: gray">(on ${location.origin} from ${event.source})</span>`,...event.args),this.handler(event)}}catch(error){import_client_logger.logger.error(error)}}},getEventSourceUrl=event=>{let frames=Array.from(document.querySelectorAll("iframe[data-is-storybook]")),[frame,...remainder]=frames.filter(element=>{try{return element.contentWindow===event.source}catch{}let src=element.getAttribute("src"),origin;try{({origin}=new URL(src,document.location.toString()))}catch{return!1}return origin===event.origin});if(frame&&remainder.length===0){let src=frame.getAttribute("src"),{protocol,host,pathname}=new URL(src,document.location.toString());return`${protocol}//${host}${pathname}`}return remainder.length>0&&import_client_logger.logger.error("found multiple candidates for event source"),null};function createChannel({page}){let transport=new PostmsgTransport({page});return new import_channels.Channel({transport})}var src_default=createChannel;0&&(module.exports={KEY,PostmsgTransport,createChannel});
