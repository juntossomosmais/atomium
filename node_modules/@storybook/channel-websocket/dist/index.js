var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __hasOwnProp=Object.prototype.hasOwnProperty;var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:!0})},__copyProps=(to,from,except,desc)=>{if(from&&typeof from=="object"||typeof from=="function")for(let key of __getOwnPropNames(from))!__hasOwnProp.call(to,key)&&key!==except&&__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable});return to};var __toCommonJS=mod=>__copyProps(__defProp({},"__esModule",{value:!0}),mod);var src_exports={};__export(src_exports,{WebsocketTransport:()=>WebsocketTransport,createChannel:()=>createChannel,default:()=>src_default});module.exports=__toCommonJS(src_exports);var import_global=require("@storybook/global"),import_channels=require("@storybook/channels"),import_client_logger=require("@storybook/client-logger"),import_telejson=require("telejson"),{WebSocket}=import_global.global,WebsocketTransport=class{constructor({url,onError}){this.buffer=[];this.isReady=!1;this.connect(url,onError)}setHandler(handler){this.handler=handler}send(event){this.isReady?this.sendNow(event):this.sendLater(event)}sendLater(event){this.buffer.push(event)}sendNow(event){let data=(0,import_telejson.stringify)(event,{maxDepth:15,allowFunction:!0});this.socket.send(data)}flush(){let{buffer}=this;this.buffer=[],buffer.forEach(event=>this.send(event))}connect(url,onError){this.socket=new WebSocket(url),this.socket.onopen=()=>{this.isReady=!0,this.flush()},this.socket.onmessage=({data})=>{let event=typeof data=="string"&&(0,import_telejson.isJSON)(data)?(0,import_telejson.parse)(data):data;this.handler(event)},this.socket.onerror=e=>{onError&&onError(e)}}};function createChannel({url,async=!1,onError=err=>import_client_logger.logger.warn(err)}){let transport=new WebsocketTransport({url,onError});return new import_channels.Channel({transport,async})}var src_default=createChannel;0&&(module.exports={WebsocketTransport,createChannel});
