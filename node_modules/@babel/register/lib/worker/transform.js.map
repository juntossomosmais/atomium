{"version":3,"names":["cloneDeep","require","path","fs","babel","registerCache","nmRE","escapeRegExp","sep","string","replace","cache","transformOpts","exports","setOptions","opts","clear","load","get","extensions","caller","name","cwd","resolve","ignore","undefined","only","cwdRE","RegExp","transform","input","filename","loadOptionsAsync","sourceRoot","dirname","cached","store","cacheLookup","code","map","transformAsync","sourceMaps","ast","transformSync","OptionManager","init","id","value","cacheKey","JSON","stringify","version","env","getEnv","fileMtime","statSync","mtime","setDirty"],"sources":["../../src/worker/transform.js"],"sourcesContent":["\"use strict\";\n\nconst cloneDeep = require(\"clone-deep\");\nconst path = require(\"path\");\nconst fs = require(\"fs\");\n\nconst babel = require(\"./babel-core\");\nconst registerCache = require(\"../cache\");\n\nconst nmRE = escapeRegExp(path.sep + \"node_modules\" + path.sep);\n\nfunction escapeRegExp(string) {\n  return string.replace(/[|\\\\{}()[\\]^$+*?.]/g, \"\\\\$&\");\n}\n\nlet cache;\nlet transformOpts;\nexports.setOptions = function (opts) {\n  if (opts.cache === false && cache) {\n    registerCache.clear();\n    cache = null;\n  } else if (opts.cache !== false && !cache) {\n    registerCache.load();\n    cache = registerCache.get();\n  }\n\n  delete opts.cache;\n  delete opts.extensions;\n\n  transformOpts = {\n    ...opts,\n    caller: {\n      name: \"@babel/register\",\n      ...(opts.caller || {}),\n    },\n  };\n\n  let { cwd = \".\" } = transformOpts;\n\n  // Ensure that the working directory is resolved up front so that\n  // things don't break if it changes later.\n  cwd = transformOpts.cwd = path.resolve(cwd);\n\n  if (transformOpts.ignore === undefined && transformOpts.only === undefined) {\n    const cwdRE = escapeRegExp(cwd);\n\n    // Only compile things inside the current working directory.\n    transformOpts.only = [new RegExp(\"^\" + cwdRE, \"i\")];\n    // Ignore any node_modules inside the current working directory.\n    transformOpts.ignore = [\n      new RegExp(`^${cwdRE}(?:${path.sep}.*)?${nmRE}`, \"i\"),\n    ];\n  }\n};\n\nexports.transform = async function (input, filename) {\n  const opts = await babel.loadOptionsAsync({\n    // sourceRoot can be overwritten\n    sourceRoot: path.dirname(filename) + path.sep,\n    ...cloneDeep(transformOpts),\n    filename,\n  });\n\n  // Bail out ASAP if the file has been ignored.\n  if (opts === null) return null;\n\n  const { cached, store } = cacheLookup(opts, filename);\n  if (cached) return cached;\n\n  const { code, map } = await babel.transformAsync(input, {\n    ...opts,\n    sourceMaps: opts.sourceMaps === undefined ? \"both\" : opts.sourceMaps,\n    ast: false,\n  });\n\n  return store({ code, map });\n};\n\nif (!process.env.BABEL_8_BREAKING) {\n  exports.transformSync = function (input, filename) {\n    const opts = new babel.OptionManager().init({\n      // sourceRoot can be overwritten\n      sourceRoot: path.dirname(filename) + path.sep,\n      ...cloneDeep(transformOpts),\n      filename,\n    });\n\n    // Bail out ASAP if the file has been ignored.\n    if (opts === null) return null;\n\n    const { cached, store } = cacheLookup(opts, filename);\n    if (cached) return cached;\n\n    const { code, map } = babel.transformSync(input, {\n      ...opts,\n      sourceMaps: opts.sourceMaps === undefined ? \"both\" : opts.sourceMaps,\n      ast: false,\n    });\n\n    return store({ code, map });\n  };\n}\n\nconst id = value => value;\n\nfunction cacheLookup(opts, filename) {\n  if (!cache) return { cached: null, store: id };\n\n  let cacheKey = `${JSON.stringify(opts)}:${babel.version}`;\n\n  const env = babel.getEnv();\n  if (env) cacheKey += `:${env}`;\n\n  const cached = cache[cacheKey];\n  const fileMtime = +fs.statSync(filename).mtime;\n\n  if (cached && cached.mtime === fileMtime) {\n    return { cached: cached.value, store: id };\n  }\n\n  return {\n    cached: null,\n    store(value) {\n      cache[cacheKey] = { value, mtime: fileMtime };\n      registerCache.setDirty();\n      return value;\n    },\n  };\n}\n"],"mappings":"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"}