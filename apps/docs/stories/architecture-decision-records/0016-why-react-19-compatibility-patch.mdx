import { Meta } from '@storybook/addon-docs/blocks'

<Meta title="Docs/Architecture Decision Records/ADR 0016: Why React 19 compatibility patch?" />

# ADR 0016: Why React 19 compatibility patch?

üóìÔ∏è 2025-11 ¬∑ ‚úçÔ∏è [@felipefialho](https://twitter.com/felipefialho_)

## Context

Atomium uses Stencil to build Web Components and generates React wrappers using `@stencil/react-output-target`. The project wraps many `@ionic/core` components within custom Stencil components, and we need to upgrade to React 19 to keep dependencies up-to-date.

## Problems

### Problem 1: Locked to react-output-target 0.5.3

We are locked to `@stencil/react-output-target` version **0.5.3** and cannot upgrade to newer versions (0.7.4+) due to a breaking change that affects Stencil components using `@ionic/core`:

* **Version 0.5.3**: Works correctly with Ionic-dependent components
* **Version 0.7.4+**: Components wrapping Ionic components fail to render; non-Ionic components work normally

The breaking change involves the removal of the `includeDefineCustomElements` option, which was crucial for automatic custom element registration in React projects.

Reference: [GitHub Issue #552 - React Output Target fails with Ionic components](https://github.com/stenciljs/output-targets/issues/552)

**Technical details:**
* Stencil version: 4.38.2
* TypeScript config: `"module": "esnext"` and `"moduleResolution": "bundler"`
* ESM-only module generation
* Web Components wrapping Ionic Framework components

### Problem 2: React 19 type incompatibility

React 19 introduced stricter TypeScript types for `ForwardRef` and component props. The code generated by `@stencil/react-output-target` 0.5.3 produces type errors when compiled against React 19:

```typescript
// Generated by @stencil/react-output-target 0.5.3
return React.forwardRef<OverlayType, Props>((props, ref) => {
  return <Overlay {...props} forwardedRef={ref} />;
});

// TypeScript Error with React 19:
// TS2322: Type 'PropsWithoutRef<Props> & { forwardedRef: ForwardedRef<OverlayType>; }'
// is not assignable to type 'IntrinsicAttributes & IntrinsicClassAttributes<Overlay> & Readonly<Props>'
```

### Constraints

* **Cannot upgrade `@stencil/react-output-target`**: Breaking changes in 0.7.4+ prevent Ionic components from rendering
* **Cannot stay on React 18**: Need to keep dependencies up-to-date for security and ecosystem alignment
* **Cannot modify generated files manually**: Files are regenerated on every build by Stencil
* **Must maintain type safety**: TypeScript compilation must pass without errors

## Decision

We decided to implement a **custom Stencil output target** that modifies the generated React wrapper files to be compatible with React 19, following the same pattern as the existing `reactBooleanFixOutputTarget`.

### Implementation

**1. Custom Output Target**: `packages/core/output-target/react-19-fix.ts`
* Runs during the Stencil build process
* Listens for the `react-library` generation to complete
* Applies type assertions to work around React 19's stricter types
* Is idempotent (safe to run multiple times)
* Includes detection for already-patched files

**2. Stencil Configuration**: Added to `packages/core/stencil.config.ts`

```typescript
import { react19FixOutputTarget } from './output-target/react-19-fix'

export const config: Config = {
  outputTargets: [
    // ... other output targets
    react19FixOutputTarget({
      createOverlayComponentFile:
        '../../react/src/components/react-component-lib/createOverlayComponent.tsx',
      utilsIndexFile:
        '../../react/src/components/react-component-lib/utils/index.tsx',
    }),
  ]
}
```

**3. Files Patched:**
* `createOverlayComponent.tsx`: Adds type assertions for overlay component refs
* `utils/index.tsx`: Adds type assertions for `createForwardRef` function

### Patch Details

**File: `createOverlayComponent.tsx`**

```typescript
// Before (generated by Stencil)
return React.forwardRef<OverlayType, Props>((props, ref) => {
  return <Overlay {...props} forwardedRef={ref} />;
});

// After (patched for React 19)
return React.forwardRef<OverlayType, Props>((props, ref) => {
  const overlayProps = { ...props, forwardedRef: ref } as any;
  return <Overlay {...overlayProps} />;
}) as any;
```

**File: `utils/index.tsx`**

```typescript
// Before (generated by Stencil)
return React.forwardRef(forwardRef);

// After (patched for React 19)
return React.forwardRef(forwardRef as any) as any;
```

### Testing

Comprehensive test suite in `packages/core/output-target/react-19-fix.spec.ts` validates:
* ‚úÖ Correct patching of both files during Stencil build
* ‚úÖ Integration with Stencil's compilation lifecycle
* ‚úÖ Graceful handling of missing files

### Positive outcomes

* **React 19 Compatibility**: Project successfully builds and runs with React 19.2.0
* **Maintains Ionic Integration**: Can continue using `@stencil/react-output-target` 0.5.3
* **Automated Solution**: No manual intervention required; patches apply automatically on every build
* **Type Safety Maintained**: TypeScript compilation passes without errors
* **Testable**: Patch logic is thoroughly tested
* **Future-Proof**: When `@stencil/react-output-target` resolves Ionic issues, we can upgrade and remove the patch

### Trade-offs

* **Type Assertions Used**: The `as any` assertions bypass TypeScript's type checking for these specific cases
  * Risk is low - the underlying implementation is sound; only the type definitions are incompatible
  * Mitigated by comprehensive runtime testing through Storybook and component tests
* **Build Dependency**: Adds an extra step in the build process (minimal impact - script executes in milliseconds)
* **Maintenance Burden**: Need to monitor for changes in generated code structure
  * Test suite will catch breaking changes
  * Patch script warns when patterns aren't found
* **Technical Debt**: This is a workaround, not a permanent solution
  * We track [GitHub Issue #552](https://github.com/stenciljs/output-targets/issues/552) for resolution
  * When Ionic compatibility is fixed in newer versions, we can upgrade and remove the patch

## Alternatives considered

### Alternative 1: Fork `@stencil/react-output-target`

**Rejected** - Too much maintenance overhead. Would require manually syncing updates and maintaining divergence from official package.

### Alternative 2: Downgrade to React 18

**Rejected** - Not sustainable long-term. Would create security vulnerabilities and ecosystem misalignment.

### Alternative 3: Rewrite Components Without Ionic

**Rejected** - Not feasible. Would require rewriting 100+ components, losing Ionic's battle-tested implementations, and risk introducing bugs.

### Alternative 4: Wait for Upstream Fix

**Rejected** - Cannot wait indefinitely. Issue has been open since May 2024 with no timeline for resolution. This blocks React 19 adoption and creates security risks.

## References

* [GitHub Issue #552: React Output Target fails with Ionic components](https://github.com/stenciljs/output-targets/issues/552)
* [React 19 Release Notes](https://react.dev/blog/2024/12/05/react-19)
* [Stencil React Output Target Documentation](https://stenciljs.com/docs/react)
* [Stencil Custom Output Targets](https://stenciljs.com/docs/output-targets#custom-output-targets)
* Output Target Implementation: `packages/core/output-target/react-19-fix.ts`
* Test Suite: `packages/core/output-target/react-19-fix.spec.ts`
* Related: ADR 0010 (React Boolean Fix) - Similar pattern
